<app-shared-navbar></app-shared-navbar>
<div class="bg-secondary">
  <div class="container mx-auto p-4 md:p-8">
    <!-- Loading state -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
    </div>

    <!-- Error state -->
    <div *ngIf="error" class="error-container">
      <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h2 class="error-title">{{ error }}</h2>
      <button (click)="loadCourse(course?.id || '')" class="retry-button">
        Try Again
      </button>
    </div>

    <!-- Course content -->
    <div *ngIf="!loading && !error && course" class="course-grid">
      <!-- Main Content -->
      <div class="main-content">
        <!-- Breadcrumbs -->
        <nav class="breadcrumbs">
          <span>Home</span> >
          <span>{{ course.category.name || 'Categories' }}</span> >
          <span>{{ course.title }}</span>
        </nav>

        <!-- Course Header -->
        <h1 class="course-title">{{ course.title }}</h1>
        <p class="course-description">{{ course.description }}</p>

        <!-- Course Meta -->
        <div class="course-meta">
          <div class="rating-container">
            <svg *ngFor="let i of [1,2,3,4,5]"
                 class="star-icon"
                 [class.star-filled]="i <= ((course._count.reviews || 0) > 0 ? 4 : 0)"
                 [class.star-empty]="i > ((course._count.reviews || 0) > 0 ? 4 : 0)"
                 fill="currentColor"
                 viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
            </svg>
          </div>
          <span class="meta-item">{{ course._count.reviews }} reviews</span>
          <span class="meta-item">{{ getTotalLessons() }} lessons</span>
          <span class="meta-item">{{ getTotalModules() }} modules</span>
          <span class="meta-item">{{ course.difficulty }}</span>
        </div>

        <!-- Instructor -->
        <div class="instructor-info">
          <ng-container *ngIf="course.instructor?.profileImage; else showInitials">
            <img [src]="course.instructor.profileImage" [alt]="getInstructorName()" class="instructor-avatar">
          </ng-container>
          <ng-template #showInitials>
            <div class="instructor-avatar instructor-initials">
              {{ getInstructorInitials() }}
            </div>
          </ng-template>
          <div class="instructor-details">
            <p class="instructor-name">{{ getInstructorName() }}</p>
            <p class="instructor-title">{{ course.instructor.about || 'Course Instructor' }}</p>
          </div>
        </div>

        <!-- Additional Meta -->
        <div class="additional-meta">
          <span class="meta-item">Created: {{ course.createdAt | date }}</span>
          <span class="meta-item">Last updated: {{ course.updatedAt | date }}</span>
          <span *ngIf="course.category" class="meta-item">Category: {{ course.category.name }}</span>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
          <nav class="tabs-nav">
            <button (click)="setActiveTab('description')" 
                    class="tab-link" 
                    [class.active]="activeTab === 'description'">
              Description
            </button>
            <button (click)="setActiveTab('instructor')" 
                    class="tab-link" 
                    [class.active]="activeTab === 'instructor'">
              Instructor
            </button>
            <button (click)="setActiveTab('syllabus')" 
                    class="tab-link" 
                    [class.active]="activeTab === 'syllabus'">
              Syllabus
            </button>
            <button (click)="setActiveTab('reviews')" 
                    class="tab-link" 
                    [class.active]="activeTab === 'reviews'">
              Reviews
            </button>
          </nav>
        </div>

        <!-- Course Description Section -->
        <div *ngIf="activeTab === 'description'" class="content-section">
          <h2 class="section-title">Course Description</h2>
          <p class="section-text">{{ course.description }}</p>
          <h3 class="subsection-title">Certification</h3>
          <p class="section-text">At Byway, we understand the significance of formal recognition for your hard work and dedication. Upon successful completion of our courses, you will earn a prestigious certification that not only validates your expertise but also opens doors to new opportunities in your chosen field.</p>
        </div>

        <!-- Instructor Details -->
        <div *ngIf="activeTab === 'instructor'" class="content-section">
          <h2 class="section-title">Instructor</h2>
          <div class="instructor-detailed">
            <ng-container *ngIf="course.instructor?.profileImage; else showInstructorInitials">
              <img [src]="getInstructorImage()"
                   [alt]="getInstructorName()"
                   class="instructor-avatar-large">
            </ng-container>
            <ng-template #showInstructorInitials>
              <div class="instructor-avatar-large instructor-initials-large">
                {{ getInstructorInitials() }}
              </div>
            </ng-template>
            <div class="instructor-info-detailed">
              <p class="instructor-name-large">{{ getInstructorName() }}</p>
              <p class="instructor-title">Course Instructor</p>
              <div class="instructor-stats">
                <span class="stat-item">★ 4.5 Instructor Rating</span>
                <span class="stat-item">{{ course._count.reviews || 0 }} Reviews</span>
                <span class="stat-item">{{ course._count.enrollments || 0 }} Students</span>
                <span class="stat-item">{{ getInstructorCourseCount() }} Courses</span>
              </div>
            </div>
          </div>
          <p class="section-text">{{ course.instructor.about || 'No instructor information available.' }}</p>
        </div>

        <!-- Syllabus -->
        <div *ngIf="activeTab === 'syllabus'" class="content-section">
          <h2 class="section-title">Course Content</h2>
          <div class="course-stats">
            <div class="stats-grid">
              <span class="stat-item">{{ getTotalModules() }} modules</span>
              <span class="stat-separator">•</span>
              <span class="stat-item">{{ getTotalLessons() }} lessons</span>
              <span class="stat-separator">•</span>
              <span class="stat-item">{{ course.difficulty }} level</span>
            </div>
          </div>
          <div class="modules-container">
            <div *ngFor="let module of course.modules" class="module-card">
              <div (click)="toggleModule(module)" class="module-header">
                <h3 class="module-title">{{ module.title }}</h3>
                <div class="module-meta">
                  <span class="lesson-count">{{ module.lessons.length }} lessons</span>
                  <svg class="chevron-icon"
                       [class.rotated]="module.open"
                       fill="none"
                       stroke="currentColor"
                       viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div *ngIf="module.open" class="module-content">
                <div class="lessons-list">
                  <div *ngFor="let lesson of module.lessons" 
                       class="lesson-item"
                       [class.enrolled]="isEnrolled"
                       [class.clickable]="isEnrolled"
                       (click)="isEnrolled ? accessLesson(lesson) : null">
                    <!-- Icon based on content type -->
                    <svg *ngIf="lesson.contentType === 'video'" class="lesson-icon video-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <svg *ngIf="lesson.contentType === 'pdf'" class="lesson-icon pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    <svg *ngIf="lesson.contentType === 'text'" class="lesson-icon text-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="lesson-title">{{ lesson.title }}</span>
                    <!-- Access indicator for enrolled students -->
                    <svg *ngIf="isEnrolled" class="access-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Learner Reviews -->
        <div *ngIf="activeTab === 'reviews'" class="content-section">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Learner Reviews</h2>
            <!-- Add Review Button - Only for enrolled students who haven't reviewed -->
            <button 
              *ngIf="user?.role === 'STUDENT' && isEnrolled && !userHasReviewed && !showReviewForm"
              (click)="toggleReviewForm()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
              Add Review
            </button>
          </div>

          <!-- Review Form -->
          <div *ngIf="showReviewForm" class="bg-gray-50 rounded-lg p-4 mb-6">
            <h3 class="text-md font-semibold text-gray-800 mb-3">Write Your Review</h3>
            
            <!-- Rating Stars -->
            <div class="flex items-center mb-3">
              <span class="text-sm text-gray-700 mr-2">Rating:</span>
              <div class="flex gap-1">
                <ng-container *ngFor="let i of [1,2,3,4,5]">
                  <button 
                    (click)="setReviewRating(i)"
                    class="text-2xl transition-colors"
                    [ngClass]="{'text-yellow-400': i <= newReviewRating, 'text-gray-300': i > newReviewRating}">
                    ★
                  </button>
                </ng-container>
              </div>
              <span class="ml-2 text-sm text-gray-600">{{ newReviewRating }}/5</span>
            </div>
            
            <!-- Review Comment -->
            <div class="mb-3">
              <label class="block text-sm text-gray-700 mb-1">Your Review:</label>
              <textarea 
                [(ngModel)]="newReviewComment"
                rows="4"
                placeholder="Share your experience with this course..."
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">
              </textarea>
            </div>
            
            <!-- Submit/Cancel Buttons -->
            <div class="flex gap-2">
              <button 
                (click)="submitReview()"
                [disabled]="submittingReview || !newReviewComment.trim()"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <span *ngIf="submittingReview">Submitting...</span>
                <span *ngIf="!submittingReview">Submit Review</span>
              </button>
              <button 
                (click)="toggleReviewForm()"
                [disabled]="submittingReview"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50">
                Cancel
              </button>
            </div>
          </div>
          <div class="reviews-summary" *ngIf="courseReviews">
            <span class="rating-score">{{ courseReviews.averageRating.toFixed(1) }}</span>
            <div class="rating-details">
              <div class="stars-container">
                <ng-container *ngFor="let i of [1,2,3,4,5]">
                  <svg *ngIf="i <= courseReviews.averageRating" class="star-icon filled" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <svg *ngIf="i > courseReviews.averageRating" class="star-icon empty" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </ng-container>
              </div>
              <span class="rating-count">{{ courseReviews.totalReviews }} ratings</span>
            </div>
            <div class="rating-breakdown">
              <div class="rating-bar">
                <div class="rating-bar-bg">
                  <div class="rating-bar-fill" style="width: 80%"></div>
                </div>
                <span class="rating-label">
                  <svg *ngFor="let i of [1,2,3,4,5]" class="star-icon small filled" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </span>
                <span class="rating-count">{{ getRatingCount(5) }}</span>
              </div>
              <div class="rating-bar">
                <div class="rating-bar-bg">
                  <div class="rating-bar-fill" [style.width.%]="getRatingPercentage(5)"></div>
                </div>
                <span class="rating-label">
                  <svg *ngFor="let i of [1,2,3,4]" class="star-icon small filled" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <svg class="star-icon small empty" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </span>
                <span class="rating-count">{{ course.totalReviews || 0 }}</span>
              </div>
              <div class="rating-bar">
                <div class="rating-bar-bg">
                  <div class="rating-bar-fill" [style.width.%]="getRatingPercentage(3)"></div>
                </div>
                <span class="rating-label">
                  <svg *ngFor="let i of [1,2,3]" class="star-icon small filled" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <svg *ngFor="let i of [1,2]" class="star-icon small empty" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </span>
                <span class="rating-count">{{ getRatingCount(3) }}</span>
              </div>
              <div class="rating-bar">
                <div class="rating-bar-bg">
                  <div class="rating-bar-fill" [style.width.%]="getRatingPercentage(2)"></div>
                </div>
                <span class="rating-label">
                  <svg *ngFor="let i of [1,2]" class="star-icon small filled" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <svg *ngFor="let i of [1,2,3]" class="star-icon small empty" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </span>
                <span class="rating-count">{{ getRatingCount(2) }}</span>
              </div>
              <div class="rating-bar">
                <div class="rating-bar-bg">
                  <div class="rating-bar-fill" [style.width.%]="getRatingPercentage(1)"></div>
                </div>
                <span class="rating-label">
                  <svg class="star-icon small filled" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <svg *ngFor="let i of [1,2,3,4]" class="star-icon small empty" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </span>
                <span class="rating-count">{{ course.totalReviews || 0 }}</span>
              </div>
            </div>
          </div>
          <div class="reviews-list">
            <div *ngIf="loadingReviews" class="text-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
              <p class="text-gray-600 mt-2">Loading reviews...</p>
            </div>
            <div *ngIf="!loadingReviews && reviews.length === 0" class="text-center py-8">
              <p class="text-gray-600">No reviews yet. Be the first to review this course!</p>
            </div>
            <div *ngFor="let review of reviews" class="review-card">
              <div class="review-header">
                <img [src]="review.student.profileImage || '/assets/images/student1-removebg-preview.png'" alt="{{ review.student.firstName }} {{ review.student.lastName }}" class="reviewer-avatar">
                <div class="review-content">
                  <div class="reviewer-info">
                    <h4 class="reviewer-name">{{ review.student.firstName }} {{ review.student.lastName }}</h4>
                    <div class="review-stars">
                      <ng-container *ngFor="let i of [1,2,3,4,5]">
                        <svg *ngIf="i <= review.rating" class="star-icon small filled" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                        <svg *ngIf="i > review.rating" class="star-icon small" fill="none" stroke="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                      </ng-container>
                    </div>
                    <span class="review-date">{{ review.createdAt | date:'shortDate' }}</span>
                  </div>
                  <p class="review-text">{{ review.comment || 'No comment provided' }}</p>
                </div>
              </div>
            </div>
          </div>
          <button class="view-all-reviews-btn">View All Reviews</button>
        </div>

        <!-- Related Courses -->
        <div class="content-section">
          <h2 class="section-title">
            <ng-container *ngIf="hasSameCategoryCourses(); else otherCoursesTitle">
              More Courses Like This
            </ng-container>
            <ng-template #otherCoursesTitle>
              Other Courses You Might Like
            </ng-template>
          </h2>
          <div *ngIf="relatedCourses.length > 0; else noCoursesMessage" class="related-courses-grid">
            <div *ngFor="let relatedCourse of relatedCourses" class="related-course-card">
              <img [src]="relatedCourse.imageUrl" alt="{{ relatedCourse.title }}" class="course-thumbnail">
              <div class="course-info">
                <h4 class="course-name">{{ relatedCourse.title }}</h4>
                <p class="course-author">By {{ relatedCourse.instructor.firstName }} {{ relatedCourse.instructor.lastName }}</p>
                <div class="course-rating">
                  <div class="stars-container">
                    <svg *ngFor="let i of [1,2,3,4]" class="star-icon small filled" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    <svg class="star-icon small empty" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                  </div>
                  <span class="rating-count">({{ relatedCourse._count.reviews }} Ratings)</span>
                </div>
                <p class="course-price">${{ relatedCourse.price }}</p>
              </div>
            </div>
          </div>
          <ng-template #noCoursesMessage>
            <div class="no-courses-message">
              <p>No other courses available at the moment. Check back soon for new courses!</p>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="sidebar">
        <div class="sidebar-card">
          <div class="course-image-container">
            <img [src]="course.imageUrl || 'https://images.unsplash.com/photo-1513258496099-48168024aec0?auto=format&fit=crop&w=400&q=80'"
                 [alt]="course.title"
                 class="course-image">
          </div>
          <div class="pricing-section">
            <div class="price-container">
              <span class="course-price-large">KSH {{ course.price }}</span>
            </div>
            
            <!-- Access Course - For enrolled students -->
            <button 
              *ngIf="isEnrolled && !isCourseCompleted"
              class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors mb-3"
              (click)="accessCourse()">
              Access Course
            </button>
            
            <!-- Course Completed - For enrolled students who completed the course -->
            <button 
              *ngIf="isEnrolled && isCourseCompleted"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mb-3 cursor-default"
              disabled>
              <div class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Course Completed
              </div>
            </button>
            
            <!-- Add to Cart - Only for logged in students who are not enrolled -->
            <button 
              *ngIf="!isEnrolled && user?.role === 'STUDENT'"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors mb-3"
              (click)="addToCart()"
              [disabled]="isInCart">
              <span *ngIf="!isInCart">Add to Cart</span>
              <span *ngIf="isInCart">In Cart</span>
            </button>

            <!-- Go to Cart - Only for logged in students -->
            <button 
              *ngIf="user?.role === 'STUDENT'"
              class="w-full bg-gray-200 text-blue-800 py-2 rounded-lg hover:bg-blue-100 transition-colors border border-blue-700"
              (click)="goToCart()">
              Go to Cart
            </button>

            <!-- Login to Purchase - For non-logged in users -->
            <button 
              *ngIf="!authenticated"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors mb-3"
              (click)="goToLogin()">
              Login to Purchase
            </button>
          </div>
          <div class="course-features">
            <h3 class="features-title">This course includes:</h3>
            <ul class="features-list">
              <li class="feature-item">
                <svg class="feature-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ getTotalLessons() }} lessons
              </li>
              <li class="feature-item">
                <svg class="feature-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ getTotalModules() }} modules
              </li>
              <li class="feature-item">
                <svg class="feature-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Full lifetime access
              </li>
              <li class="feature-item">
                <svg class="feature-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Access on mobile and desktop
              </li>
              <li class="feature-item">
                <svg class="feature-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Certificate of completion
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
